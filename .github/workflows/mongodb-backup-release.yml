name: MongoDB Backup to Release

on:
  schedule:
    # Twice daily at 6 AM and 6 PM UTC
    - cron: '0 6,18 * * *'
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete old artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: mongodb-backup-*
          failOnError: false

      - name: Delete old workflow runs (keep only 2 most recent)
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: "HeartArmy/Light-Global-Chat"
          retain_days: 0
          keep_minimum_runs: 2

  backup:
    runs-on: ubuntu-latest
    needs: cleanup
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create backup script
        run: |
          cat > backup-mongodb.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const { MongoClient } = require('mongodb');
          // EJSON is part of the bson package which ships with the mongodb driver.
          // It serializes ObjectId, Date, and all other BSON types into MongoDB
          // Extended JSON format ( { "$oid": "..." }, { "$date": "..." } etc. )
          // so the backup is always importable without data type loss.
          const { EJSON } = require('bson');

          async function backupMongoDB() {
            try {
              if (!process.env.MONGODB_URI) {
                throw new Error('MONGODB_URI not found in environment variables');
              }

              console.log('üîÑ Starting MongoDB backup...');

              const client = new MongoClient(process.env.MONGODB_URI);
              await client.connect();
              console.log('‚úÖ Connected to MongoDB');

              const dbName =
                process.env.DATABASE_NAME ||
                new URL(process.env.MONGODB_URI).pathname.substring(1).split('?')[0] ||
                'chatdb';
              const database = client.db(dbName);

              const backupDir = path.join(process.cwd(), 'mongodb-backup');
              if (!fs.existsSync(backupDir)) {
                fs.mkdirSync(backupDir, { recursive: true });
              }

              const collections = await database.listCollections().toArray();
              console.log(`üìÅ Found ${collections.length} collections to backup`);

              let totalDocuments = 0;
              const collectionNames = [];

              for (const collectionInfo of collections) {
                const collectionName = collectionInfo.name;
                const collection = database.collection(collectionName);

                console.log(`üì¶ Backing up collection: ${collectionName}`);

                const documents = await collection.find({}).toArray();
                totalDocuments += documents.length;
                collectionNames.push(collectionName);

                const backupFile = path.join(backupDir, `${collectionName}.json`);

                // EJSON.stringify preserves all BSON types. The resulting file can
                // be reimported directly with:
                //   mongoimport --uri <uri> --collection <name> --file <file> --jsonArray
                fs.writeFileSync(backupFile, EJSON.stringify(documents, null, 2));

                console.log(`‚úÖ Backed up ${documents.length} documents from ${collectionName}`);
              }

              console.log(`üéâ Backup completed! Total documents: ${totalDocuments}`);

              const backupInfo = {
                timestamp: new Date().toISOString(),
                database: dbName,
                collectionCount: collections.length,
                totalDocuments,
                collections: collectionNames,
              };

              fs.writeFileSync(
                path.join(backupDir, 'backup-info.json'),
                JSON.stringify(backupInfo, null, 2)
              );

              await client.close();
              console.log('üîì Disconnected from MongoDB');

              return backupDir;
            } catch (error) {
              console.error('‚ùå Backup failed:', error);
              throw error;
            }
          }

          backupMongoDB()
            .then((backupDir) => {
              console.log('‚úÖ Backup successful:', backupDir);
              process.exit(0);
            })
            .catch((error) => {
              console.error('‚ùå Backup failed:', error);
              process.exit(1);
            });
          EOF

      - name: Run MongoDB backup
        env:
          MONGODB_URI: "${{ secrets.MONGODB_URI }}"
          DATABASE_NAME: "${{ secrets.DATABASE_NAME }}"
        run: |
          if [[ "$MONGODB_URI" != mongodb://* && "$MONGODB_URI" != mongodb+srv://* ]]; then
            echo "‚ö†Ô∏è  MongoDB URI missing scheme, adding mongodb+srv://"
            MONGODB_URI="mongodb+srv://$MONGODB_URI"
          fi

          echo "Database name: $DATABASE_NAME"
          node backup-mongodb.js

      - name: Upload MongoDB Backup as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mongodb-backup-${{ github.run_number }}
          path: mongodb-backup/
          retention-days: 90
          overwrite: true

      - name: Cleanup
        if: always()
        run: rm -rf backup-mongodb.js mongodb-backup/