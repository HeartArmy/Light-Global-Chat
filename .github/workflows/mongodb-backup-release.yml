name: MongoDB Backup to Release

on:
  schedule:
    # Twice daily at 6 AM and 6 PM UTC
    - cron: '0 6,18 * * *'
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete old artifacts
        uses: geekyeggo/delete-artifact@v2
        with:
          name: "mongodb-backup-*"
          useGlob: true
          failOnError: false

      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 7
          keep_minimum_runs: 5

  backup:
    runs-on: ubuntu-latest
    needs: cleanup
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create backup script
        run: |
          cat > backup-mongodb.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const { MongoClient } = require('mongodb');
          // Remove dotenv dependency since we're using environment variables directly

          async function backupMongoDB() {
            try {
              if (!process.env.MONGODB_URI) {
                throw new Error('MONGODB_URI not found in environment variables');
              }

              console.log('üîÑ Starting MongoDB backup...');
              
              // Connect to MongoDB
              const client = new MongoClient(process.env.MONGODB_URI);
              await client.connect();
              console.log('‚úÖ Connected to MongoDB');

              // Use database name from environment variable or extract from URI
              const dbName = process.env.DATABASE_NAME || new URL(process.env.MONGODB_URI).pathname.substring(1).split('?')[0] || 'chatdb';
              const database = client.db(dbName);
              
              // Create backup directory
              const backupDir = path.join(process.cwd(), 'mongodb-backup');
              if (!fs.existsSync(backupDir)) {
                fs.mkdirSync(backupDir, { recursive: true });
              }

              // Get all collections
              const collections = await database.listCollections().toArray();
              console.log(`üìÅ Found ${collections.length} collections to backup`);

              let totalDocuments = 0;

              // Backup each collection
              for (const collectionInfo of collections) {
                const collectionName = collectionInfo.name;
                const collection = database.collection(collectionName);
                
                console.log(`üì¶ Backing up collection: ${collectionName}`);
                
                // Get all documents from collection
                const documents = await collection.find({}).toArray();
                totalDocuments += documents.length;
                
                // Save to JSON file
                const backupFile = path.join(backupDir, `${collectionName}.json`);
                fs.writeFileSync(backupFile, JSON.stringify(documents, null, 2));
                
                console.log(`‚úÖ Backed up ${documents.length} documents from ${collectionName}`);
              }

              console.log(`üéâ Backup completed! Total documents backed up: ${totalDocuments}`);
              
              // Create backup info file
              const backupInfo = {
                timestamp: new Date().toISOString(),
                database: dbName,
                collections: collections.length,
                totalDocuments: totalDocuments,
                collections: collections.map(c => c.name)
              };
              
              fs.writeFileSync(
                path.join(backupDir, 'backup-info.json'),
                JSON.stringify(backupInfo, null, 2)
              );

              await client.close();
              console.log('üîì Disconnected from MongoDB');
              
              return backupDir;
            } catch (error) {
              console.error('‚ùå Backup failed:', error);
              throw error;
            }
          }

          // Run the backup
          backupMongoDB()
            .then((backupDir) => {
              console.log('‚úÖ Backup successful:', backupDir);
              process.exit(0);
            })
            .catch((error) => {
              console.error('‚ùå Backup failed:', error);
              process.exit(1);
            });
          EOF

      - name: Run MongoDB backup
        env:
          MONGODB_URI: "${{ secrets.MONGODB_URI }}"
          DATABASE_NAME: "${{ secrets.DATABASE_NAME }}"
        run: |
          # Ensure MongoDB URI has proper scheme (strict check)
          if [[ "$MONGODB_URI" != mongodb://* && "$MONGODB_URI" != mongodb+srv://* ]]; then
            echo "‚ö†Ô∏è  MongoDB URI missing scheme, adding mongodb+srv://"
            MONGODB_URI="mongodb+srv://$MONGODB_URI"
            echo "Modified URI: $MONGODB_URI"
          fi
          
          echo "Database name: $DATABASE_NAME"
          node backup-mongodb.js

      - name: Upload MongoDB Backup as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mongodb-backup-${{ github.run_number }}
          path: mongodb-backup/
          retention-days: 90
          overwrite: true

      - name: Cleanup
        if: always()
        run: |
          # Remove the backup script and directory after creating release
          rm -rf backup-mongodb.js mongodb-backup/